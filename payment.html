<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment | Quiz App</title>
  <style>
    body {
      background: linear-gradient(to right, #56ccf2, #2f80ed);
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .payment-box {
      background-color: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
      text-align: center;
      width: 400px;
    }
    h2 {
      color: #2f80ed;
    }
    p {
      color: #333;
    }
    .price {
      font-size: 26px;
      color: green;
      margin: 15px 0;
    }
    button {
      width: 100%;
      padding: 12px;
      background-color: #2f80ed;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background-color: #1a64c7;
    }
  </style>
</head>
<body>

<div class="payment-box">
  <h2>Complete Your Payment</h2>
  <p id="status">Checking your trial status...</p>
  <p class="price" id="price"></p>
  <p id="timer"></p>

  <button onclick="payNow()">Pay Now</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let finalPrice = 0;
  let currency = '';
  let uid = '';

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      uid = user.uid;
      const docRef = doc(db, "users", uid);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        const country = data.country || 'Other';
        const trialEnd = data.trialEnd ? new Date(data.trialEnd.seconds * 1000) : null;
        const paymentDone = data.paymentStatus === 'paid';
        const now = new Date();

        if (paymentDone) {
          document.getElementById('status').innerText = 'âœ… Payment already completed.';
          document.getElementById('price').innerText = '';
          document.getElementById('timer').innerText = '';
          return;
        }

        // Currency
        currency = (country === 'India') ? 'â‚¹' : '$';

        if (trialEnd && trialEnd > now) {
          // During free trial
          document.getElementById('status').innerText = 'ðŸ†“ Free Trial Active';
          document.getElementById('price').innerText = `${currency}0`;
          startCountdown(trialEnd, "Trial Ends In:");
          finalPrice = 0;
        } else {
          // Trial expired
          const graceEnd = new Date(trialEnd.getTime() + 24 * 60 * 60 * 1000);
          if (now <= graceEnd) {
            document.getElementById('status').innerText = 'âš ï¸ Trial expired - Grace period active';
            finalPrice = (country === 'India') ? 599 : 15;
            document.getElementById('price').innerText = `${currency}${finalPrice}`;
            startCountdown(graceEnd, "Discount Ends In:");
          } else {
            document.getElementById('status').innerText = 'âŒ Trial and Grace period ended';
            finalPrice = (country === 'India') ? 650 : 20;
            document.getElementById('price').innerText = `${currency}${finalPrice}`;
            document.getElementById('timer').innerText = '';
          }
        }
      }
    } else {
      window.location.href = "index.html";
    }
  });

  function startCountdown(endDate, label) {
    const timerDiv = document.getElementById('timer');
    const x = setInterval(() => {
      const now = new Date().getTime();
      const distance = endDate.getTime() - now;

      if (distance <= 0) {
        clearInterval(x);
        timerDiv.innerText = `${label} expired.`;
      } else {
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        timerDiv.innerText = `${label} ${hours}h ${minutes}m ${seconds}s`;
      }
    }, 1000);
  }

  async function payNow() {
    if (finalPrice === 0) {
      alert("Free Trial - No payment needed.");
      window.location.href = 'student-dashboard.html';
      return;
    }

    await updateDoc(doc(db, "users", uid), {
      paymentStatus: "paid",
      accessExpiry: new Date(new Date().getTime() + 60 * 60 * 24 * 60 * 1000) // 2 months from now
    });

    alert("âœ… Payment successful. Access granted for 2 months.");
    window.location.href = 'student-dashboard.html';
  }
</script>

</body>
</html>
